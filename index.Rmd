---
title: "Physiospace Web Interface"
author: ""
date: "July, 2018"
output: html_document
runtime: shiny
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
require(PhysioSpaceMethods)
require(HumanPhysioSpace)
require(parallel)
# Allow upload of 1GB tables
options(shiny.maxRequestSize=1024^3) 
options(mc.cores=detectCores())
```

Please upload your table (max. 1GB). For details on how to prepare it, please consult the
Vignette of the R package `PhysioSpaceMethods`.

```{r, echo = FALSE}
fileInput("file1", "Choose CSV File",
  multiple = TRUE,
  accept = c("text/csv",
           "text/comma-separated-values,text/plain",
           ".csv")
)

reactive(
  if(! is.null(input$file1$datapath)) {
    # Create a Progress object
    progress <- shiny::Progress$new()
    # Make sure it closes when we exit this reactive, even if there's an error
    on.exit(progress$close())
    # Show progress message
    progress$set(message = "Analyzing data. This can take a while..", value = 0)
    # Read uploaded data
    counts.df <- as.matrix(read.csv(input$file1$datapath))
    # Normalize read counts as deviations from mean
    counts.relative <- counts.df - apply(counts.df, 1, mean)
    # Calculate the Physiospace Map
    physio.map <- calculatePhysioMap(
      InputData = counts.relative, 
      Space = HS_LUKK_Space, PARALLEL = T, 
      NumbrOfCores = getOption("mc.cores", 1)
    )
  }
)
```